<?php
ini_set('display_errors', '1');
require 'vendor/autoload.php';
use PhpOffice\PhpSpreadsheet\Spreadsheet;
use PhpOffice\PhpSpreadsheet\Writer\Xlsx;
use PhpOffice\PhpSpreadsheet\IOFactory;
$mysqli = new mysqli("srv1723.hstgr.io","u470700275_08", "z9#KqH!YK2VEyJpT", "u470700275_08");
if ($mysqli->connect_error) {
    die(json_encode(['success' => false, 'message' => "Error de conexión: " . $mysqli->connect_error]));
}
// Obtener parámetros
$tipo = $_POST['tipo'] ?? '5';
$fecha_inicio = $_POST['fecha_inicio'] ?? '';
$fecha_fin = $_POST['fecha_fin'] ?? '';
// Validar fechas
if (empty($fecha_inicio) || empty($fecha_fin)) {
    die(json_encode(['success' => false, 'message' => 'Debe proporcionar ambas fechas']));
}
// Escapar fechas para seguridad
$fecha_inicio = $mysqli->real_escape_string($fecha_inicio);
$fecha_fin = $mysqli->real_escape_string($fecha_fin);
// Definir todos los scripts posibles con filtros de fecha
$todosScripts = [
    "Asignacion Predios" => "SELECT G.subred AS Subred, G.idgeo AS Cod_Predio, G.localidad AS Localidad, CONCAT('_', G.sector_catastral, G.nummanzana, G.predio_num, G.unidad_habit) AS Cod_Sector_Catastral, U.id_usuario AS Cod_Asignado, U.nombre AS Nombre_Asignado, U.perfil AS Perfil_Asignado, A.fecha_create AS Fecha_Asignacion, U1.id_usuario AS Cod_Quien_Asigno, U1.nombre AS Nombre_Quien_Asigno, U1.perfil AS Perfil_Quien_Asigno FROM `geo_asig` A LEFT JOIN hog_geo G ON A.idgeo=G.idgeo  LEFT JOIN usuarios U ON A.doc_asignado=U.id_usuario  LEFT JOIN usuarios U1 ON A.usu_create=U1.id_usuario 
    WHERE G.subred in (3) AND A.fecha_create >='$fecha_inicio' AND A.fecha_create <='$fecha_fin'",

    "Gestion Predios" => "SELECT G.idgeo AS Cod_Predio, A.id_ges AS Cod_Registro, G.subred AS Cod_Subred, FN_CATALOGODESC(72,G.subred) AS Subred, G.zona AS Zona, G.localidad AS Cod_Localidad, FN_CATALOGODESC(2,G.localidad) AS Localidad, G.upz AS Cod_Upz, FN_CATALOGODESC(7,G.upz) AS Upz, G.barrio AS Cod_Barrio, C.descripcion AS Barrio, CONCAT('_', G.sector_catastral, G.nummanzana, G.predio_num) AS Cod_Sector, G.sector_catastral AS Sector_catastral, G.nummanzana AS N°_Manzana, G.predio_num AS N°_Predio, G.unidad_habit AS Unidad_Habitacional, G.direccion AS Direccion, G.vereda AS Vereda, G.cordx AS Coordenada_X, G.cordy AS Coordenada_Y, G.estrato AS Estrato, A.direccion_nueva AS Direccion_Nueva, A.vereda_nueva AS Vereda_Nueva, A.cordxn AS Coordenada_X_Nueva, A.cordyn AS Coordenada_Y_Nueva, FN_CATALOGODESC(44,A.estado_v) AS Estado_Visita, FN_CATALOGODESC(5,A.motivo_estado) AS Motivo_Estado, A.usu_creo AS Cod_Usuario, U.nombre AS Nombre_Usuario, U.perfil AS Perfil_Usuario, A.fecha_create AS Fecha_Creacion FROM `geo_gest` A  LEFT JOIN hog_geo G ON A.idgeo=G.idgeo  LEFT JOIN catadeta C ON G.barrio = C.idcatadeta  LEFT JOIN usuarios U ON A.usu_creo=U.id_usuario 
    WHERE G.subred in (3) AND A.fecha_create >='$fecha_inicio' AND A.fecha_create <='$fecha_fin'",

    "Compromisos" => "SELECT G.idgeo Cod_Predio,C.idviv AS Cod_Familia,C.idcon AS Cod_Registro,G.subred AS Subred,C.fecha AS Fecha, C.compromiso AS Compromiso_Concertado, FN_CATALOGODESC(26,C.equipo) AS Equipo,S.fecha_seg AS Fecha_Seguimiento,FN_CATALOGODESC(234,S.tipo_seg) AS Tipo_Seguimiento, FN_CATALOGODESC(170,S.estado_seg) AS Estado_Seguimiento, S.obs_seg AS Observacion_Seguimiento,C.usu_creo AS Usuario_Creo,U.nombre AS Nombre_Creo, U.perfil AS Perfil_Creo, U.equipo AS Equipo_Creo, C.fecha_create AS Fecha_Creacion FROM `hog_planconc` C LEFT JOIN hog_segcom S ON C.idcon=S.id_con LEFT JOIN hog_plancuid P ON P.idviv = C.idviv LEFT JOIN hog_fam F ON C.idviv = F.id_fam LEFT JOIN hog_geo G ON F.idpre = G.idgeo LEFT JOIN usuarios U ON C.usu_creo = U.id_usuario
    WHERE G.subred IN (3) AND C.fecha >= '$fecha_inicio' AND C.fecha <='$fecha_fin'",

    "Seguimientos"=>"SELECT G.idgeo AS Cod_Predio,C.idviv AS Cod_Familia,P.idpeople AS Cod_persona,C.idcon AS Cod_Comp, S.id_segcom AS Cod_Segui,S.fecha_seg AS fecha_Seg,FN_CATALOGODESC(234, S.tipo_seg) AS Tipo_Seg,FN_CATALOGODESC(170, S.estado_seg) AS Cumplio, S.obs_seg AS Observacion, U.nombre, U.perfil FROM hog_segcom S LEFT JOIN hog_planconc C ON S.id_con = C.idcon LEFT JOIN hog_fam F ON C.idviv = F.id_fam LEFT JOIN hog_geo G ON F.idpre = G.idgeo LEFT JOIN usuarios U ON S.usu_create = U.id_usuario LEFT JOIN person P ON C.idviv = P.vivipersona 
    WHERE G.subred IN (3) AND S.fecha_seg >= '$fecha_inicio' AND A.fecha_seg <='$fecha_fin' GROUP BY G.idgeo, C.idviv, P.idpeople, S.id_segcom, S.fecha_seg, S.tipo_seg, S.estado_seg, S.obs_seg, U.nombre, U.perfil;",

    "Atenciones"=>"SELECT G.subred AS Subred, G.localidad AS Localidad, G.idgeo AS Cod_predio, F.id_fam AS Cod_Familia,P.idpeople AS Cod_Persona, P.tipo_doc AS Tipo_Documento, P.idpersona AS N°_Docuumento, CONCAT(P.nombre1, ' ', P.nombre2) AS Nombres_Usuario,CONCAT(P.apellido1, ' ', P.apellido2) AS Apellidos_Usuario,P.fecha_nacimiento AS Fecha_Nacimiento,FN_CATALOGODESC(21,P.sexo) AS Sexo, FN_CATALOGODESC(30,P.nacionalidad) AS Nacionalidad, FN_CATALOGODESC(16,P.etnia) AS Etnia,FN_CATALOGODESC(15,P.pueblo) AS Pueblo_Etnia, FN_CATALOGODESC(14,P.discapacidad) AS Tipo_Discapacidad, FN_CATALOGODESC(17,P.regimen) AS Regimen, FN_CATALOGODESC(18,P.eapb) AS Eapb,A.id_aten AS Cod_Registro, A.id_factura AS Cod_Admision, A.fecha_atencion AS Fecha_Consulta, FN_CATALOGODESC(182,A.tipo_consulta) AS Tipo_Consulta, FN_CATALOGODESC(126,A.codigo_cups) AS Codigo_CUPS, FN_CATALOGODESC(127,A.finalidad_consulta) AS Finalidad_Consulta, FN_DESC(3,A.diagnostico1) AS DX1,FN_DESC(3,A.diagnostico2) AS DX2, FN_DESC(3,A.diagnostico3) AS DX3, A.fertil AS '¿Mujer_Edad_Fertil?', A.preconcepcional AS '¿Consulta_Preconsecional?', A.metodo AS '¿Metodo_Planificacion?', FN_CATALOGODESC(129,A.anticonceptivo) AS '¿Cua_Metodo?', A.planificacion AS Planificacion,A.mestruacion AS Fur,A.vih AS Prueba_VIH, FN_CATALOGODESC(187,A.resul_vih) AS Resultado_VIH, A.hb AS Prueba_HB, FN_CATALOGODESC(188,A.resul_hb) AS Resultado_HB, A.trepo_sifil AS Trepomina_Sifilis, FN_CATALOGODESC(188,A.resul_sifil) AS Resultado_Trepo_Sifilis, A.pru_embarazo AS Prueba_Embarazo, FN_CATALOGODESC(88,A.resul_emba) AS Resultado_Embarazo, A.pru_apetito AS Prueba_Apetito, A.resul_apetito AS Resultado_Apetito,A.orden_psicologia AS Orden_Psicologia, A.relevo AS Aplica_Relevo, FN_CATALOGODESC(203,A.estrategia) AS Estrategia, FN_CATALOGODESC(236,A.motivo_estrategia) AS Motivo_Estrategia,A.usu_creo AS Cod_Usuario, U.nombre AS Nombre_Usuario, U.perfil AS Perfil_Usuario, A.fecha_create AS Fecha_Creacion FROM `eac_atencion` A  LEFT JOIN person P ON A.idpeople = P.idpeople LEFT JOIN hog_fam F ON P.vivipersona =  F.id_fam LEFT JOIN hog_geo G ON F.idpre = G.idgeo LEFT JOIN usuarios U ON A.usu_creo = U.id_usuario 
    WHERE G.subred IN (3) AND A.fecha_atencion >= '$fecha_inicio' AND A.fecha_atencion <='$fecha_fin'",

    "SesColectivas"=>"SELECT G.idgeo AS Cod_Predio, G.subred AS Subred, G.zona AS Zona, G.localidad, C.id_cole AS Cod_Registro, C.fecha AS Fecha_Sesion, FN_CATALOGODESC(239,C.tipo_activ) AS Tipo_Actividad, C.lugar AS Lugar_Actividad, FN_CATALOGODESC(242,C.jornada) AS Jornada_Actividad, C.equipo AS Equipo_Realiza_Actividad,FN_CATALOGODESC(237,C.tematica1) AS Actividad_Tematica_1, FN_CATALOGODESC(238,C.des_temati1) AS Descrip_Tematica_1,FN_CATALOGODESC(237,C.tematica2) AS Actividad_Tematica_2, FN_CATALOGODESC(238,C.des_temati2) AS Descrip_Tematica_2,FN_CATALOGODESC(237,C.tematica3) AS Actividad_Tematica_3, FN_CATALOGODESC(238,C.des_temati3) AS Descrip_Tematica_3,FN_CATALOGODESC(237,C.tematica4) AS Actividad_Tematica_4, FN_CATALOGODESC(238,C.des_temati4) AS Descrip_Tematica_4,FN_CATALOGODESC(237,C.tematica5) AS Actividad_Tematica_5, FN_CATALOGODESC(238,C.des_temati5) AS Descrip_Tematica_5,FN_CATALOGODESC(237,C.tematica6) AS Actividad_Tematica_6, FN_CATALOGODESC(238,C.des_temati6) AS Descrip_Tematica_6,FN_CATALOGODESC(237,C.tematica7) AS Actividad_Tematica_7, FN_CATALOGODESC(238,C.des_temati7) AS Descrip_Tematica_7,FN_CATALOGODESC(237,C.tematica8) AS Actividad_Tematica_8, FN_CATALOGODESC(238,C.des_temati8) AS Descrip_Tematica_8,P.id_person AS Cod_Persona, P.tipo_doc AS Tipo_Documento, P.idpersona AS N°_Documento, P.nombre1 AS Primer_Nombre, P.nombre2 AS Segundo_Nombre, P.apellido1 AS Primer_Apellido, P.apellido2 AS Seundo_Apellido, P.fecha_nacimiento AS Fecha_Nacimiento, FN_CATALOGODESC(21,P.sexo) AS Sexo, FN_CATALOGODESC(19,P.genero) AS Genero, FN_CATALOGODESC(30,P.nacionalidad) AS Nacionalidad, FN_CATALOGODESC(16,P.etnia) AS Etnia, FN_CATALOGODESC(15,P.pueblo) AS Pueblo_Etnia, FN_CATALOGODESC(17,P.regimen) AS Regimen,FN_CATALOGODESC(18,P.eapb) AS Eapb,C.usu_create AS Usuario_Creo, U.nombre AS Nombre_Creo, U.perfil AS Perfil_Creo, U.equipo AS Equipo_Creo FROM `persescol` P  LEFT JOIN hog_sescole C ON P.sesion = C.id_cole LEFT JOIN hog_geo G ON C.idpre = G.idgeo LEFT JOIN usuarios U ON C.usu_create = U.id_usuario
     WHERE G.subred IN (3) AND C.fecha >= '$fecha_inicio' AND C.fecha <='$fecha_fin'",

    "SesRBC"=>"SELECT G.subred AS Subred, G.idgeo Cod_Predio, F.id_fam AS Cod_Familia, R.id_people AS Cod_Persona, R.idsesion AS Cod_Registro,R.rel_validacion1 AS N°_Sesion, R.rel_validacion2 AS Fecha_Sesion, R.rel_validacion3 AS Perfil, FN_CATALOGODESC(301,R.rel_validacion4) AS Actividad_Respiro, R.rel_validacion5 AS Descripcion_Intervencion,FN_CATALOGODESC(103,R.autocuidado) AS Autocuidado, FN_CATALOGODESC(194,R.activesparc) AS Actividades_Esparcimiento, FN_CATALOGODESC(157,R.infeducom) AS Inf_Educa_Comuni_salud,R.usu_creo AS Usuario_Creo, U.nombre AS Nombre_Creo, U.perfil AS Perfil_Creo, U.equipo AS Equipo_Creo FROM `rel_sesion` R  LEFT JOIN person P ON R.id_people = P.idpeople  LEFT JOIN hog_fam F ON P.vivipersona = F.id_fam LEFT JOIN hog_geo G ON F.idpre = G.idgeo LEFT JOIN usuarios U ON R.usu_creo= U.id_usuario
    WHERE G.subred IN (3) AND R.rel_validacion2 >= '$fecha_inicio' AND R.rel_validacion2 <='$fecha_fin'",

    "SesPSi1"=>"SELECT G.idgeo Cod_Predio, F.id_fam AS Cod_Familia, A.idpsi AS Cod_Registro, G.subred AS Subred, FN_CATALOGODESC(3,G.zona) AS Zona, G.localidad AS Localidad,P.tipo_doc AS Tipo_Documento,P.idpersona AS N°_Documento,concat(P.nombre1,' ',P.nombre2) AS Nombres,concat(P.apellido1,' ',P.apellido2) AS Apellidos,P.fecha_nacimiento AS Fecha_Nacimiento,FN_CATALOGODESC(21,P.sexo) AS Sexo,FN_CATALOGODESC(19,P.genero) AS Genero,FN_CATALOGODESC(30,P.nacionalidad) AS Nacionalidad,FN_CATALOGODESC(16,P.etnia) AS Etnia,FN_CATALOGODESC(15,P.pueblo) AS Pueblo,A.fecha_ses1 AS Fecha_Sesion, A.tipo_caso AS Tipo_de_Caso, A.cod_admin AS Cod_Admision, H.analisis AS Hamilton_Inicial, Z.analisis AS Zung_Inicial, W.analisis AS Whodas_Inicial, A.eva_chips AS Resultado_Eva_Chips,A.psi_validacion1 AS Pensamiento_Termina_Vida, A.psi_validacion2 AS Accion_Termina_Vida, A.psi_validacion3 AS Plan_termina_Vida_Sem, A.psi_validacion4 AS Descripcion_Evaluacion, A.psi_validacion5 AS Persona_Le_Entiende, A.psi_validacion6 AS Persona_Acompaña_Razonable, A.psi_validacion7 AS Respuestas_Raras_Inusuales,A.psi_validacion8 AS No_Contacto_Realidad, A.psi_validacion9 AS Posibles_Transtornos, A.psi_validacion10 AS Plan_Termina_Vida, A.psi_validacion11 AS Posible_Transtorno_Mental, FN_DESC(3,A.psi_diag12) as Impresion_DX, A.psi_validacion13 AS Plan_Menejo_Terapeutico, A.psi_validacion14 AS No_Plan_Manejo_Terapeutico, A.otro AS Otro, A.psi_validacion15 AS Descripcion_Plan_Manejo, A.numsesi AS N°_Sesiones,A.usu_creo, U.nombre AS Nombre_Creo, U.perfil AS Perfil_Creo, A.fecha_create FROM `psi_psicologia` A LEFT JOIN person P ON A.id_people = P.idpeople LEFT JOIN hog_fam F ON P.vivipersona = F.id_fam LEFT JOIN hog_geo G ON F.idpre = G.idgeo LEFT JOIN hog_tam_hamilton H ON A.id_people = H.idpeople AND H.momento = 1  LEFT JOIN hog_tam_zung Z ON A.id_people = Z.idpeople AND Z.momento = 1  LEFT JOIN hog_tam_whodas W ON A.id_people = W.idpeople AND W.momento = 1 LEFT JOIN usuarios U ON A.usu_creo = U.id_usuario
    WHERE G.subred IN (3) AND A.fecha_ses1 >= '$fecha_inicio' AND A.fecha_ses1 <='$fecha_fin'",

    "SesPsi"=>"SELECT G.idgeo Cod_Predio, F.id_fam AS Cod_Familia, A.id_sesion2 AS Cod_Registro, G.subred AS Subred, FN_CATALOGODESC(3,G.zona) AS Zona, G.localidad AS Localidad,P.tipo_doc AS Tipo_Documento,P.idpersona AS N°_Documento,concat(P.nombre1,' ',P.nombre2) AS Nombres,concat(P.apellido1,' ',P.apellido2) AS Apellidos,P.fecha_nacimiento AS Fecha_Nacimiento,FN_CATALOGODESC(21,P.sexo) AS Sexo,FN_CATALOGODESC(19,P.genero) AS Genero,FN_CATALOGODESC(30,P.nacionalidad) AS Nacionalidad,FN_CATALOGODESC(16,P.etnia) AS Etnia,FN_CATALOGODESC(15,P.pueblo) AS Pueblo, A.psi_fecha_sesion AS Fecha_Sesion, A.cod_admin2 AS Cod_Admision, A.psi_validacion1 AS Problema_Que_Aflije, FN_CATALOGODESC(124,A.psi_validacion2) AS Cuanto_Afecto_Semana, A.psi_validacion3 AS Otro_Problema_Aflije, FN_CATALOGODESC(124,A.psi_validacion4) AS Otro_Cuanto_Afecto_Semana, A.psi_validacion5 AS Causa_Problema, FN_CATALOGODESC(124,A.psi_validacion6) AS Cuan_Dificil_Resultado, FN_CATALOGODESC(124,A.psi_validacion7) AS Como_Se_Sintio_Semana, A.psi_validacion8 AS Actividad_Desarrollar_1, A.psi_validacion9 AS Actividad_Desarrollar_2, A.psi_validacion10 AS Actividad_Desarrollar_3, (FN_CATALOGODESC(124,A.psi_validacion2)+FN_CATALOGODESC(124,A.psi_validacion4)+FN_CATALOGODESC(124,A.psi_validacion6)+FN_CATALOGODESC(124,A.psi_validacion7)) AS Resultado_Evaluacion, FN_CATALOGODESC(160,A.contin_caso) AS Continuidad_Caso, A.usu_creo, U.nombre AS Nombre_Creo, U.perfil AS Perfil_Creo, A.fecha_create  FROM `psi_sesion2` A  LEFT JOIN person P ON A.id_people = P.idpeople LEFT JOIN hog_fam F ON P.vivipersona = F.id_fam LEFT JOIN hog_geo G ON F.idpre = G.idgeo LEFT JOIN usuarios U ON A.usu_creo = U.id_usuario
    WHERE G.subred IN (3) AND A.psi_fecha_sesion >= '$fecha_inicio' AND A.psi_fecha_sesion <='$fecha_fin'",

    "SesPSi3-10"=>"SELECT G.idgeo Cod_Predio, F.id_fam AS Cod_Familia, A.idsesipsi AS Cod_Registro, G.subred AS Subred, FN_CATALOGODESC(3,G.zona) AS Zona, G.localidad AS Localidad,P.tipo_doc AS Tipo_Documento,P.idpersona AS N°_Documento,concat(P.nombre1,' ',P.nombre2) AS Nombres,concat(P.apellido1,' ',P.apellido2) AS Apellidos,P.fecha_nacimiento AS Fecha_Nacimiento,FN_CATALOGODESC(21,P.sexo) AS Sexo,FN_CATALOGODESC(19,P.genero) AS Genero,FN_CATALOGODESC(30,P.nacionalidad) AS Nacionalidad,FN_CATALOGODESC(16,P.etnia) AS Etnia,FN_CATALOGODESC(15,P.pueblo) AS Pueblo, A.psi_fecha_sesion AS Fecha_Sesion, FN_CATALOGODESC(125,A.psi_sesion) AS N°_Sesion, A.cod_admin4 AS Cod_Admision, A.psi_validacion1 AS Problema_Preocupa_Principio, FN_CATALOGODESC(124,A.psi_validacion2) AS Cuanto_Afecto_Semana, A.psi_validacion3 AS Otro_Problema_Aflije_Principio, FN_CATALOGODESC(124,A.psi_validacion4) AS Otro_Cuanto_Afecto_Semana, A.psi_validacion5 AS Le_Ha_Costado_Hacer_Principio,FN_CATALOGODESC(124,A.difhacer) AS Cuan_Dificil_Resultado,FN_CATALOGODESC(124,A.psi_validacion6) AS Como_Se_Sintio_Semana, A.psi_validacion7 AS Plan_Para_Terminar_Con_Su_Vida, A.psi_validacion8 AS Describa_Pensamientos_Planes, A.psi_validacion9 AS Acciones_Terminar_Su_Vida,FN_CATALOGODESC(130,A.psi_validacion10) AS Plan_Terminar_Con_Su_Vida_Prox_Semana, A.psi_validacion11 AS Describa_Su_Plan, A.psi_validacion12 AS Otro_Problema_Importante, FN_CATALOGODESC(124,A.psi_validacion13) AS Afectado_Otros_Problemas,A.psi_validacion14 AS Actividad_Desarrollar_1,A.psi_validacion15 AS Actividad_Desarrollar_2,A.psi_validacion16 AS Actividad_Desarrollar_3,(FN_CATALOGODESC(124,A.psi_validacion2)+FN_CATALOGODESC(124,A.psi_validacion4)+FN_CATALOGODESC(124,A.psi_validacion6)+FN_CATALOGODESC(124,A.difhacer)+FN_CATALOGODESC(124,A.psi_validacion13)) AS Resultado_Evaluacion,FN_CATALOGODESC(160,A.psi_validacion17) AS Continuidad_Caso,A.usu_creo, U.nombre AS Nombre_Creo, U.perfil AS Perfil_Creo, A.fecha_create FROM `psi_sesiones` A  LEFT JOIN person P ON A.id_people = P.idpeople LEFT JOIN hog_fam F ON P.vivipersona = F.id_fam LEFT JOIN hog_geo G ON F.idpre = G.idgeo LEFT JOIN usuarios U ON A.usu_creo = U.id_usuario
     WHERE G.subred IN (3) AND A.psi_fecha_sesion >= '$fecha_inicio' AND A.psi_fecha_sesion <='$fecha_fin'",

"FECHAS"=>"SELECT * FROM ( 
    SELECT G.subred, F.idpre, F.id_fam,A.id_factura Cod_Registro,'ADMISION', A.fecha_consulta as fecha_seg,NULL as fecha_cierre FROM adm_facturacion A
    LEFT JOIN person P ON A.idpeople = P.idpeople  LEFT JOIN hog_fam F ON P.vivipersona = F.id_fam   LEFT JOIN hog_geo G ON F.idpre = G.idgeo  LEFT JOIN usuarios U ON A.usu_creo = U.id_usuario  UNION         SELECT G.subred, F.idpre, F.id_fam,A.idamb Cod_Registro,'AMBIENTAL', A.fecha as fecha_seg,NULL as fecha_cierre FROM hog_amb  A LEFT JOIN hog_fam F ON A.idvivamb = F.id_fam   LEFT JOIN hog_geo G ON F.idpre = G.idgeo  LEFT JOIN usuarios U ON A.usu_creo = U.id_usuario UNION
    SELECT G.subred, F.idpre, F.id_fam,A.id_apgar Cod_Registro,'APGAR', A.fecha_toma as fecha_seg,NULL as fecha_cierre FROM hog_tam_apgar  A LEFT JOIN person P ON A.idpeople = P.idpeople  LEFT JOIN hog_fam F ON P.vivipersona = F.id_fam  LEFT JOIN hog_geo G ON F.idpre = G.idgeo  LEFT JOIN usuarios U ON A.usu_creo = U.id_usuario  UNION
    SELECT G.subred, F.idpre, F.id_fam,A.id_findrisc Cod_Registro,'FINDRISC', A.fecha_toma as fecha_seg,NULL as fecha_cierre FROM hog_tam_findrisc  A LEFT JOIN person P ON A.idpeople = P.idpeople  LEFT JOIN hog_fam F ON P.vivipersona = F.id_fam  LEFT JOIN hog_geo G ON F.idpre = G.idgeo  LEFT JOIN usuarios U ON A.usu_creo = U.id_usuario  UNION
    SELECT G.subred, F.idpre, F.id_fam,A.idoms Cod_Registro,'OMS', A.fecha_toma as fecha_seg,NULL as fecha_cierre FROM hog_tam_oms  A LEFT JOIN person P ON A.idpeople = P.idpeople  LEFT JOIN hog_fam F ON P.vivipersona = F.id_fam  LEFT JOIN hog_geo G ON F.idpre = G.idgeo  LEFT JOIN usuarios U ON A.usu_creo = U.id_usuario  UNION
    SELECT G.subred, F.idpre, F.id_fam,A.id_epoc Cod_Registro,'EPOC', A.fecha_toma as fecha_seg,NULL as fecha_cierre FROM hog_tam_epoc A LEFT JOIN person P ON A.idpeople = P.idpeople  LEFT JOIN hog_fam F ON P.vivipersona = F.id_fam  LEFT JOIN hog_geo G ON F.idpre = G.idgeo  LEFT JOIN usuarios U ON A.usu_creo = U.id_usuario  UNION
    SELECT G.subred, F.idpre, F.id_fam,A.id_signos Cod_Registro,'SIGNOS', A.fecha_toma as fecha_seg,NULL as fecha_cierre FROM hog_signos  A LEFT JOIN person P ON A.idpeople = P.idpeople  LEFT JOIN hog_fam F ON P.vivipersona = F.id_fam  LEFT JOIN hog_geo G ON F.idpre = G.idgeo  LEFT JOIN usuarios U ON A.usu_create = U.id_usuario  UNION          SELECT G.subred, F.idpre, F.id_fam,A.id_aten Cod_Registro,'ATENCION', A.fecha_atencion as fecha_seg,NULL as fecha_cierre FROM eac_atencion  A LEFT JOIN person P ON A.idpeople = P.idpeople  LEFT JOIN hog_fam F ON P.vivipersona = F.id_fam  LEFT JOIN hog_geo G ON F.idpre = G.idgeo  LEFT JOIN usuarios U ON A.usu_creo = U.id_usuario  UNION
    SELECT G.subred, F.idpre, F.id_fam,A.idviv Cod_Registro,'PLAN DE CUIDADO FAMILIAR', A.fecha as fecha_seg,NULL as fecha_cierre FROM hog_plancuid  A LEFT JOIN hog_fam F ON A.idviv = F.id_fam  LEFT JOIN hog_geo G ON F.idpre = G.idgeo  LEFT JOIN usuarios U ON A.usu_creo = U.id_usuario  UNION
    SELECT G.subred, F.idpre, F.id_fam,A.id_viv Cod_Registro,'CARACTERIZACION', A.fecha as fecha_seg,A.fechanot as fecha_cierre FROM hog_carac  A LEFT JOIN hog_fam F ON A.idfam = F.id_fam  LEFT JOIN hog_geo G ON F.idpre = G.idgeo  LEFT JOIN usuarios U ON A.usu_create = U.id_usuario  UNION
    SELECT G.subred, F.idpre, F.id_fam,A.id_alert Cod_Registro,'ALERTAS', A.fecha as fecha_seg,null as fecha_cierre FROM hog_alert A LEFT JOIN person P ON A.idpeople = P.idpeople  LEFT JOIN hog_fam F ON P.vivipersona = F.id_fam  LEFT JOIN hog_geo G ON F.idpre = G.idgeo  LEFT JOIN usuarios U ON A.usu_creo = U.id_usuario  UNION    
    SELECT G.subred, F.idpre, F.id_fam,A.id_acompsic Cod_Registro,'ACOMPAÑAMIENTO PSICOSOCIAL', A.fecha_seg,A.fecha_cierre FROM `vsp_acompsic` A LEFT JOIN person P ON A.idpeople = P.idpeople  LEFT JOIN hog_fam F ON P.vivipersona = F.id_fam  LEFT JOIN hog_geo G ON F.idpre = G.idgeo  LEFT JOIN usuarios U ON A.usu_creo = U.id_usuario  UNION
    SELECT G.subred, F.idpre, F.id_fam,A.id_psicduel Cod_Registro,'APOYO PSICOLOGICO EN DUELO', A.fecha_seg, A.fecha_cierre FROM `vsp_apopsicduel` A LEFT JOIN person P ON A.idpeople = P.idpeople  LEFT JOIN hog_fam F ON P.vivipersona = F.id_fam  LEFT JOIN hog_geo G ON F.idpre = G.idgeo  LEFT JOIN usuarios U ON A.usu_creo = U.id_usuario  UNION 
    SELECT G.subred, F.idpre, F.id_fam,A.id_bpnpret Cod_Registro,'BPN PRETÉRMINO', A.fecha_seg, A.fecha_cierre FROM `vsp_bpnpret` A LEFT JOIN person P ON A.idpeople = P.idpeople  LEFT JOIN hog_fam F ON P.vivipersona = F.id_fam  LEFT JOIN hog_geo G ON F.idpre = G.idgeo  LEFT JOIN usuarios U ON A.usu_creo = U.id_usuario  UNION 
    SELECT G.subred, F.idpre, F.id_fam,A.id_bpnterm Cod_Registro,'BPN A TÉRMINO', A.fecha_seg, A.fecha_cierre FROM `vsp_bpnterm` A LEFT JOIN person P ON A.idpeople = P.idpeople  LEFT JOIN hog_fam F ON P.vivipersona = F.id_fam  LEFT JOIN hog_geo G ON F.idpre = G.idgeo  LEFT JOIN usuarios U ON A.usu_creo = U.id_usuario  UNION 
    SELECT G.subred, F.idpre, F.id_fam,A.id_cancinfa Cod_Registro,'CANCER INFANTIL', A.fecha_seg, A.fecha_cierre FROM `vsp_cancinfa` A LEFT JOIN person P ON A.idpeople = P.idpeople  LEFT JOIN hog_fam F ON P.vivipersona = F.id_fam  LEFT JOIN hog_geo G ON F.idpre = G.idgeo  LEFT JOIN usuarios U ON A.usu_creo = U.id_usuario  UNION 
    SELECT G.subred, F.idpre, F.id_fam,A.id_condsuic Cod_Registro,'CONDUCTA SUICIDA', A.fecha_seg, A.fecha_cierre FROM `vsp_condsuic` A LEFT JOIN person P ON A.idpeople = P.idpeople  LEFT JOIN hog_fam F ON P.vivipersona = F.id_fam  LEFT JOIN hog_geo G ON F.idpre = G.idgeo  LEFT JOIN usuarios U ON A.usu_creo = U.id_usuario  UNION 
    SELECT G.subred, F.idpre, F.id_fam,A.id_cronicos Cod_Registro,'CRONICOS', A.fecha_seg, A.fecha_cierre FROM `vsp_cronicos` A LEFT JOIN person P ON A.idpeople = P.idpeople  LEFT JOIN hog_fam F ON P.vivipersona = F.id_fam  LEFT JOIN hog_geo G ON F.idpre = G.idgeo  LEFT JOIN usuarios U ON A.usu_creo = U.id_usuario  UNION 
    SELECT G.subred, F.idpre, F.id_fam,A.id_dntsevymod Cod_Registro,'DNT AGUDA, MODERADA O SEVERA - MENORES CON EXCESO DE PESO - FAMILIAS CON MENORES DE 5 AÑOS', A.fecha_seg, A.fecha_cierre FROM `vsp_dntsevymod` A LEFT JOIN person P ON A.idpeople = P.idpeople  LEFT JOIN hog_fam F ON P.vivipersona = F.id_fam  LEFT JOIN hog_geo G ON F.idpre = G.idgeo  LEFT JOIN usuarios U ON A.usu_creo = U.id_usuario  UNION 
    SELECT G.subred, F.idpre, F.id_fam,A.id_eraira Cod_Registro,'ERA IRA', A.fecha_seg, A.fecha_cierre FROM `vsp_eraira` A LEFT JOIN person P ON A.idpeople = P.idpeople  LEFT JOIN hog_fam F ON P.vivipersona = F.id_fam  LEFT JOIN hog_geo G ON F.idpre = G.idgeo  LEFT JOIN usuarios U ON A.usu_creo = U.id_usuario  UNION 
    SELECT G.subred, F.idpre, F.id_fam,A.id_gestante Cod_Registro,'FAMILIAS CON GESTANTES - BAJO PESO GESTACIONAL - OBESIDAD GESTACIONAL - MATERNAS ADOLESCENTES', A.fecha_seg, A.fecha_cierre FROM `vsp_gestantes` A LEFT JOIN person P ON A.idpeople = P.idpeople  LEFT JOIN hog_fam F ON P.vivipersona = F.id_fam  LEFT JOIN hog_geo G ON F.idpre = G.idgeo  LEFT JOIN usuarios U ON A.usu_creo = U.id_usuario  UNION 
    SELECT G.subred, F.idpre, F.id_fam,A.id_hbgestacio Cod_Registro,'HB GESTACIONAL', A.fecha_seg, A.fecha_cierre FROM `vsp_hbgest` A LEFT JOIN person P ON A.idpeople = P.idpeople  LEFT JOIN hog_fam F ON P.vivipersona = F.id_fam  LEFT JOIN hog_geo G ON F.idpre = G.idgeo  LEFT JOIN usuarios U ON A.usu_creo = U.id_usuario  UNION 
    SELECT G.subred, F.idpre, F.id_fam,A.id_mnehosp Cod_Registro,'MORBILIDAD MATERNA EXTREMA', A.fecha_seg, A.fecha_cierre FROM `vsp_mnehosp` A LEFT JOIN person P ON A.idpeople = P.idpeople  LEFT JOIN hog_fam F ON P.vivipersona = F.id_fam  LEFT JOIN hog_geo G ON F.idpre = G.idgeo  LEFT JOIN usuarios U ON A.usu_creo = U.id_usuario  UNION 
    SELECT G.subred, F.idpre, F.id_fam,A.id_otroprio Cod_Registro,'OTROS CASOS PRIORIZADOS', A.fecha_seg, A.fecha_cierre FROM `vsp_otroprio` A LEFT JOIN person P ON A.idpeople = P.idpeople  LEFT JOIN hog_fam F ON P.vivipersona = F.id_fam  LEFT JOIN hog_geo G ON F.idpre = G.idgeo  LEFT JOIN usuarios U ON A.usu_creo = U.id_usuario  UNION 
    SELECT G.subred, F.idpre, F.id_fam,A.id_saludoral Cod_Registro,'SALUD ORAL', A.fecha_seg, A.fecha_cierre FROM `vsp_saludoral` A LEFT JOIN person P ON A.idpeople = P.idpeople  LEFT JOIN hog_fam F ON P.vivipersona = F.id_fam  LEFT JOIN hog_geo G ON F.idpre = G.idgeo  LEFT JOIN usuarios U ON A.usu_creo = U.id_usuario  UNION 
    SELECT G.subred, F.idpre, F.id_fam,A.id_sificong Cod_Registro,'SIFILIS CONGENITA', A.fecha_seg, A.fecha_cierre FROM `vsp_sificong` A LEFT JOIN person P ON A.idpeople = P.idpeople  LEFT JOIN hog_fam F ON P.vivipersona = F.id_fam  LEFT JOIN hog_geo G ON F.idpre = G.idgeo  LEFT JOIN usuarios U ON A.usu_creo = U.id_usuario  UNION 
    SELECT G.subred, F.idpre, F.id_fam,A.id_sifigest Cod_Registro,'SÍFILIS GESTACIONAL', A.fecha_seg, A.fecha_cierre FROM `vsp_sifigest` A LEFT JOIN person P ON A.idpeople = P.idpeople  LEFT JOIN hog_fam F ON P.vivipersona = F.id_fam  LEFT JOIN hog_geo G ON F.idpre = G.idgeo  LEFT JOIN usuarios U ON A.usu_creo = U.id_usuario  UNION 
    SELECT G.subred, F.idpre, F.id_fam,A.id_vihgestacio Cod_Registro,'VIH GESTACIONAL', A.fecha_seg, A.fecha_cierre FROM `vsp_vihgest` A LEFT JOIN person P ON A.idpeople = P.idpeople  LEFT JOIN hog_fam F ON P.vivipersona = F.id_fam  LEFT JOIN hog_geo G ON F.idpre = G.idgeo  LEFT JOIN usuarios U ON A.usu_creo = U.id_usuario  UNION 
    SELECT G.subred, F.idpre, F.id_fam,A.id_gestante Cod_Registro,'VIOLENCIA EN GESTANTES', A.fecha_seg, A.fecha_cierre FROM `vsp_violges` A LEFT JOIN person P ON A.idpeople = P.idpeople  LEFT JOIN hog_fam F ON P.vivipersona = F.id_fam  LEFT JOIN hog_geo G ON F.idpre = G.idgeo  LEFT JOIN usuarios U ON A.usu_creo = U.id_usuario UNION 
    SELECT G.subred, F.idpre, F.id_fam,A.id_mme Cod_Registro,'MME', A.fecha_seg, A.fecha_cierre FROM `vsp_mme` A LEFT JOIN person P ON A.idpeople = P.idpeople  LEFT JOIN hog_fam F ON P.vivipersona = F.id_fam  LEFT JOIN hog_geo G ON F.idpre = G.idgeo  LEFT JOIN usuarios U ON A.usu_creo = U.id_usuario UNION 
    SELECT G.subred, F.idpre, F.id_fam,A.id_violreite Cod_Registro,'VIOLENCIA REITERADA', A.fecha_seg, A.fecha_cierre FROM `vsp_violreite` A LEFT JOIN person P ON A.idpeople = P.idpeople  LEFT JOIN hog_fam F ON P.vivipersona = F.id_fam  LEFT JOIN hog_geo G ON F.idpre = G.idgeo  LEFT JOIN usuarios U ON A.usu_creo = U.id_usuario UNION
    SELECT G.subred, F.idpre, F.id_fam,A.idcon Cod_Registro,'COMPROMISOS', A.fecha as fecha_seg, NULL as fecha_cierre FROM hog_planconc A  LEFT JOIN hog_fam F ON A.idviv= F.id_fam  LEFT JOIN hog_geo G ON F.idpre = G.idgeo  LEFT JOIN usuarios U ON A.usu_creo = U.id_usuario
    ) AS CombinedQuery WHERE fecha_seg >= '$fecha_inicio' AND fecha_seg <='$fecha_fin' AND subred = 3;",

    "Caracteriz_ALL"=>"SELECT F.idpre AS Cod_predio, F.id_fam AS Cod_familia, hc.id_viv AS Cod_Registro, FN_CATALOGODESC(3, G.zona) AS Zona, G.localidad AS Localidad, FN_CATALOGODESC(7, G.upz) AS Upz, G.barrio AS Barrio, G.direccion AS Direccion, G.estrato AS Estrato, F.telefono1 AS Telefono_1, F.telefono2 AS Telefono_2, F.telefono3 AS Telefono_3,FN_CATALOGODESC(215,hc.motivoupd) AS Motivo_Caracterizacion, FN_CATALOGODESC(87, hc.eventoupd) AS Evento_Notificado, hc.fechanot AS Fecha_Notificacion, hc.equipo AS Equipo_Caracterizacion, FN_CATALOGODESC(166, hc.crit_epi) AS CRITERIO_EPIDE, FN_CATALOGODESC(169, hc.fam_peretn) AS FAM_PERTEN_ETNICA, FN_CATALOGODESC(170, hc.fam_rurcer) AS FAMILIAS_RURALIDAD_CER, FN_CATALOGODESC(4, hc.tipo_vivienda) AS TIPO_VIVIENDA, FN_CATALOGODESC(8, hc.tenencia) AS TENENCIA_VIVIENDA, hc.dormitorios AS DORMITORIOS, hc.actividad_economica AS USO_ACTIVIDAD_ECONO, FN_CATALOGODESC(10, hc.tipo_familia) AS TIPO_FAMILIA, hc.personas AS N_PERSONAS, FN_CATALOGODESC(13, hc.ingreso) AS INGRESO_ECONOMICO_FAM, hc.energia AS SERVICIO_ENERGIA, hc.gas AS SERVICIO_GAS_NATURAL, hc.acueducto AS SERVICIO_ACUEDUCTO, hc.alcantarillado AS SERVICIO_ALCANTAR, hc.basuras AS SERVICIO_BASURAS, hc.pozo AS POZO, hc.aljibe AS ALJIBE, hc.perros AS ANIMALES_PERROS, hc.numero_perros AS N_PERROS, hc.perro_vacunas AS N_PERROS_NOVACU, hc.perro_esterilizado AS N_PERROS_NOESTER, hc.gatos AS ANIMALES_GATOS, hc.numero_gatos AS N_GATOS, hc.gato_vacunas AS N_GATOS_NOVACU, hc.gato_esterilizado AS N_GATOS_NOESTER, hc.otros AS OTROS_ANIMALES, hc.facamb1 AS FACTORES_AMBIEN_PRE1, hc.facamb2 AS FACTORES_AMBIEN_PRE2, hc.facamb3 AS FACTORES_AMBIEN_PRE3, hc.facamb4 AS FACTORES_AMBIEN_PRE4, hc.facamb5 AS FACTORES_AMBIEN_PRE5, hc.facamb6 AS FACTORES_AMBIEN_PRE6, hc.facamb7 AS FACTORES_AMBIEN_PRE7, hc.facamb8 AS FACTORES_AMBIEN_PRE8, hc.facamb9 AS FACTORES_AMBIEN_PRE9, hc.observacion AS OBSERVACIONES, U.id_usuario AS Cod_Usuario, U.nombre AS Nombre_Usuario, U.perfil AS Perfil_Usuario, hc.fecha_create AS Fecha_Creacion, hc.fecha AS fecha_Caracterizacion, hp.fecha AS 'Plan de Cuidado',A.fecha AS Fecha_Alerta, hs.fecha_toma  AS Fecha_Signos,DATEDIFF(hc.fecha_create, hc.fecha) as diferencia_dias_carac  
        FROM person P LEFT JOIN hog_fam F ON P.vivipersona = F.id_fam LEFT JOIN hog_geo G ON F.idpre = G.idgeo LEFT JOIN hog_alert A ON P.idpeople = A.idpeople LEFT JOIN hog_signos hs ON P.idpeople = hs.idpeople LEFT JOIN hog_carac hc ON F.id_fam = hc.idfam LEFT JOIN usuarios U ON hc.usu_create = U.id_usuario LEFT JOIN hog_plancuid hp ON hc.idfam = hp.idviv
         WHERE G.subred IN (3) AND hc.fecha >= '$fecha_inicio' AND hc.fecha <='$fecha_fin' group by 1,2",

         "Caracteriz_OK"=>"SELECT F.idpre AS Cod_predio, F.id_fam AS Cod_familia, hc.id_viv AS Cod_Registro, FN_CATALOGODESC(3, G.zona) AS Zona, G.localidad AS Localidad, FN_CATALOGODESC(7, G.upz) AS Upz, G.barrio AS Barrio, G.direccion AS Direccion, G.estrato AS Estrato, F.telefono1 AS Telefono_1, F.telefono2 AS Telefono_2, F.telefono3 AS Telefono_3,FN_CATALOGODESC(215,hc.motivoupd) AS Motivo_Caracterizacion, FN_CATALOGODESC(87, hc.eventoupd) AS Evento_Notificado, hc.fechanot AS Fecha_Notificacion, hc.equipo AS Equipo_Caracterizacion, FN_CATALOGODESC(166, hc.crit_epi) AS CRITERIO_EPIDE, FN_CATALOGODESC(169, hc.fam_peretn) AS FAM_PERTEN_ETNICA, FN_CATALOGODESC(170, hc.fam_rurcer) AS FAMILIAS_RURALIDAD_CER, FN_CATALOGODESC(4, hc.tipo_vivienda) AS TIPO_VIVIENDA, FN_CATALOGODESC(8, hc.tenencia) AS TENENCIA_VIVIENDA, hc.dormitorios AS DORMITORIOS, hc.actividad_economica AS USO_ACTIVIDAD_ECONO, FN_CATALOGODESC(10, hc.tipo_familia) AS TIPO_FAMILIA, hc.personas AS N_PERSONAS, FN_CATALOGODESC(13, hc.ingreso) AS INGRESO_ECONOMICO_FAM, hc.energia AS SERVICIO_ENERGIA, hc.gas AS SERVICIO_GAS_NATURAL, hc.acueducto AS SERVICIO_ACUEDUCTO, hc.alcantarillado AS SERVICIO_ALCANTAR, hc.basuras AS SERVICIO_BASURAS, hc.pozo AS POZO, hc.aljibe AS ALJIBE, hc.perros AS ANIMALES_PERROS, hc.numero_perros AS N_PERROS, hc.perro_vacunas AS N_PERROS_NOVACU, hc.perro_esterilizado AS N_PERROS_NOESTER, hc.gatos AS ANIMALES_GATOS, hc.numero_gatos AS N_GATOS, hc.gato_vacunas AS N_GATOS_NOVACU, hc.gato_esterilizado AS N_GATOS_NOESTER, hc.otros AS OTROS_ANIMALES, hc.facamb1 AS FACTORES_AMBIEN_PRE1, hc.facamb2 AS FACTORES_AMBIEN_PRE2, hc.facamb3 AS FACTORES_AMBIEN_PRE3, hc.facamb4 AS FACTORES_AMBIEN_PRE4, hc.facamb5 AS FACTORES_AMBIEN_PRE5, hc.facamb6 AS FACTORES_AMBIEN_PRE6, hc.facamb7 AS FACTORES_AMBIEN_PRE7, hc.facamb8 AS FACTORES_AMBIEN_PRE8, hc.facamb9 AS FACTORES_AMBIEN_PRE9, hc.observacion AS OBSERVACIONES, U.id_usuario AS Cod_Usuario, U.nombre AS Nombre_Usuario, U.perfil AS Perfil_Usuario, hc.fecha_create AS Fecha_Creacion, hc.fecha AS fecha_Caracterizacion, hp.fecha AS 'Plan de Cuidado',A.fecha AS Fecha_Alerta, hs.fecha_toma  AS Fecha_Signos,DATEDIFF(hc.fecha_create, hc.fecha) as diferencia_dias_carac  
        FROM person P LEFT JOIN hog_fam F ON P.vivipersona = F.id_fam LEFT JOIN hog_geo G ON F.idpre = G.idgeo LEFT JOIN hog_alert A ON P.idpeople = A.idpeople LEFT JOIN hog_signos hs ON P.idpeople = hs.idpeople LEFT JOIN hog_carac hc ON F.id_fam = hc.idfam LEFT JOIN usuarios U ON hc.usu_create = U.id_usuario LEFT JOIN hog_plancuid hp ON hc.idfam = hp.idviv
         WHERE G.subred IN (3)  AND hc.motivoupd=A.tipo AND hc.fecha >= '$fecha_inicio' AND hc.fecha <='$fecha_fin' group by 1,2",

    "ALERTAS" => "SELECT G.idgeo Cod_Predio,F.id_fam AS Cod_Familia,A.id_alert AS Cod_Registro,G.subred AS Subred, G.zona AS Zona, G.localidad AS Localidad, P.idpeople AS Cod_Persona, P.tipo_doc AS Tipo_Documento, P.idpersona AS N°_Documento, P.nombre1 AS Primer_Nombre, P.nombre2 AS Segundo_Nombre, P.apellido1 AS Primer_Apellido, P.apellido2 AS Seundo_Apellido, P.fecha_nacimiento AS Fecha_Nacimiento, FN_CATALOGODESC(21,P.sexo) AS Sexo,FN_CATALOGODESC(30,P.nacionalidad) AS Nacionalidad, FN_CATALOGODESC(16,P.etnia) AS Etnia, FN_CATALOGODESC(178,P.pobladifer) AS Poblacion_Diferencial, FN_CATALOGODESC(14,P.discapacidad) AS Tipo_Discapacidad, FN_CATALOGODESC(175,P.ocupacion) AS Ocupacion, FN_CATALOGODESC(17,P.regimen) AS Regimen,FN_CATALOGODESC(18,P.eapb) AS Eapb, FN_CATALOGODESC(176,A.cursovida) AS Curso_de_Vida, A.fecha AS Fecha, FN_CATALOGODESC(34,A.tipo) AS Tipo_Intervencion,FN_CATALOGODESC(166,A.crit_epi) AS Criterio_Epidemiologico,   FN_CATALOGODESC(170,A.men_dnt) AS Menor_Con_DNT, FN_CATALOGODESC(170,A.men_sinctrl) AS Menor_Sin_Control, FN_CATALOGODESC(170,A.gestante) AS Usuaria_Gestante, FN_CATALOGODESC(177,A.etapgest) AS Etapa_Gestacional, FN_CATALOGODESC(170,A.ges_sinctrl) AS Gestante_Sin_Control, FN_CATALOGODESC(170,A.cronico) AS Usuario_Cronico, FN_CATALOGODESC(170,A.cro_hiper) AS Dx_Hipertencion, FN_CATALOGODESC(170,A.cro_diabe) AS Dx_Diabetes, FN_CATALOGODESC(170,A.cro_epoc) AS Dx_Epoc, FN_CATALOGODESC(170,A.cro_sinctrl) AS Cronico_Sin_Control, FN_CATALOGODESC(170,A.esq_vacun) AS Esquema_de_vacunacion_Completo,  A.alert1 AS Alerta_N°_1, A.selmul1 AS  Descripcion_Alerta_N°_1, A.alert2 AS Alerta_N°_2, A.selmul2 AS  Descripcion_Alerta_N°_2, A.alert3 AS Alerta_N°_3,A.selmul3 AS  Descripcion_Alerta_N°_3, A.alert4 AS Alerta_N°_4,A.selmul4 AS  Descripcion_Alerta_N°_4, A.alert5 AS Alerta_N°_5,A.selmul5 AS  Descripcion_Alerta_N°_5,A.alert6 AS Alerta_N°_6,A.selmul6 AS  Descripcion_Alerta_N°_6, FN_CATALOGODESC(170,A.agen_intra) AS Agendamiento_Promotor, A.servicio AS Serivicio_Agendado, A.fecha_cita AS Fecha_de_la_Cita, A.hora_cita AS Hora_de_la_Cita, A.lugar_cita AS Lugar_de_la_Cita, FN_CATALOGODESC(170,A.deriva_pf) AS Derivacion_a_PCF,FN_CATALOGODESC(87,A.evento_pf) AS Evento_PCF, A.usu_creo AS Usuario_Creo, U.nombre AS Nombre_Creo, U.perfil AS Perfil_Creo, U.equipo AS Equipo_Creo, A.fecha_create AS Fecha_Creacion, TA.Descripcion_APGAR,MAX(TC.descripciona) AS 'Cope Afrontamiento',MAX(TC.descripcione) AS 'Cope Evitacion',MAX(TE.descripcion) AS Epoc,MAX(TF.descripcion) AS Findrisc,MAX(TOM.descripcion) AS OMS FROM  `hog_alert` A LEFT JOIN person P ON A.idpeople = P.idpeople LEFT JOIN hog_fam F ON P.vivipersona = F.id_fam LEFT JOIN hog_geo G ON F.idpre = G.idgeo LEFT JOIN usuarios U ON A.usu_creo = U.id_usuario LEFT JOIN hog_tam_cope TC ON A.idpeople = TC.idpeople LEFT JOIN hog_tam_epoc TE ON A.idpeople = TE.idpeople LEFT JOIN hog_tam_findrisc TF ON A.idpeople = TF.idpeople LEFT JOIN hog_tam_oms TOM ON A.idpeople = TOM.idpeople LEFT JOIN (     SELECT          F.id_fam AS Familia_ID,         GROUP_CONCAT(TA.descripcion SEPARATOR ', ') AS Descripcion_APGAR     FROM          hog_tam_apgar TA         LEFT JOIN person P ON TA.idpeople = P.idpeople         LEFT JOIN hog_fam F ON P.vivipersona = F.id_fam     GROUP BY F.id_fam ) TA ON F.id_fam = TA.Familia_ID
        WHERE  G.subred IN (3) AND A.fecha>= '$fecha_inicio' AND A.fecha <='$fecha_fin' GROUP BY G.idgeo, F.id_fam, A.id_alert, A.fecha",

        "UsuariosXFamilia"=>"SELECT G.localidad,G.idgeo AS Cod_predio, F.id_fam AS Cod_familia,COUNT(P.idpeople) AS Usuarios,P.usu_creo Documento_Creo,U.nombre AS Nombre_Creo,U.perfil AS Perfil_Creo,U.equipo AS Equipo_Creo FROM person P LEFT JOIN hog_fam F ON P.vivipersona = F.id_fam LEFT JOIN hog_geo G ON F.idpre = G.idgeo LEFT JOIN usuarios U ON P.usu_creo = U.id_usuario
        WHERE P.fecha_create >= '$fecha_inicio' AND P.fecha_create <='$fecha_fin' and G.subred=3 GROUP BY F.id_fam, G.idgeo, U.nombre;",
        
        "Promedio"=>"SELECT DISTINCT U.id_usuario AS Usu_Creo,G.localidad,U.nombre AS Nombre_Creo,U.perfil AS Perfil_Creo,U.equipo AS Equipo_Creo,AVG(COUNT(P.idpeople)) OVER (PARTITION BY P.usu_creo) AS Promedio_Usuarios_Por_Familia FROM person P LEFT JOIN hog_fam F ON P.vivipersona = F.id_fam LEFT JOIN usuarios U ON P.usu_creo = U.id_usuario left join hog_geo G ON F.idpre=G.idgeo
        WHERE P.fecha_create >= '$fecha_inicio' AND P.fecha_create <='$fecha_fin' AND G.subred=3 GROUP BY P.usu_creo, F.id_fam, U.id_usuario, U.nombre, U.perfil, U.equipo order by 2;",

        "VSP" => "SELECT * FROM (
        SELECT G.subred, G.localidad, F.idpre, F.id_fam,A.id_acompsic Cod_Registro, A.idpeople,P.idpersona,P.tipo_doc,CONCAT_WS(' ',P.nombre1,P.nombre2,P.apellido1,P.apellido2) Nombres,P.fecha_nacimiento,P.sexo,P.nacionalidad,P.regimen,P.eapb, A.fecha_seg,A.numsegui,FN_CATALOGODESC(87,A.evento),FN_CATALOGODESC(73,A.estado_s),FN_CATALOGODESC(170,A.cierre_caso),A.fecha_cierre,FN_CATALOGODESC(198,A.motivo_cierre),FN_CATALOGODESC(170,A.activa_ruta) activa_ruta,FN_CATALOGODESC(79,A.ruta) Ruta,A.observaciones, A.equipo_bina, A.usu_creo, U.nombre, U.perfil,A.fecha_create Fecha_Creo,DATEDIFF(A.fecha_create,A.fecha_seg) AS Dias,character_length(A.observaciones) AS largo FROM `vsp_acompsic` A LEFT JOIN  person P ON A.idpeople = P.idpeople LEFT JOIN  hog_fam F ON P.vivipersona = F.id_fam LEFT JOIN  hog_geo G ON F.idpre = G.idgeo LEFT JOIN  usuarios U ON A.usu_creo = U.id_usuario UNION 
        SELECT G.subred,G.localidad, F.idpre, F.id_fam,B.id_psicduel Cod_Registro, B.idpeople,P.idpersona,P.tipo_doc,CONCAT_WS(' ',P.nombre1,P.nombre2,P.apellido1,P.apellido2) Nombres,P.fecha_nacimiento,P.sexo,P.nacionalidad,P.regimen,P.eapb, B.fecha_seg, B.numsegui,FN_CATALOGODESC(87,B.evento),FN_CATALOGODESC(73,B.estado_s),FN_CATALOGODESC(170,B.cierre_caso),B.fecha_cierre,FN_CATALOGODESC(198,B.motivo_cierre),FN_CATALOGODESC(170,B.activa_ruta) activa_ruta,FN_CATALOGODESC(79,B.ruta) Ruta,B.observaciones, B.equipo_bina, B.usu_creo, U.nombre, U.perfil,B.fecha_create,DATEDIFF(B.fecha_create,B.fecha_seg) AS Dias,character_length(B.observaciones) AS largo  FROM `vsp_apopsicduel` B LEFT JOIN  person P ON B.idpeople = P.idpeople LEFT JOIN  hog_fam F ON P.vivipersona = F.id_fam LEFT JOIN  hog_geo G ON F.idpre = G.idgeo LEFT JOIN  usuarios U ON B.usu_creo = U.id_usuario UNION 
        SELECT G.subred,G.localidad, F.idpre, F.id_fam,C.id_bpnpret Cod_Registro, C.idpeople,P.idpersona,P.tipo_doc,CONCAT_WS(' ',P.nombre1,P.nombre2,P.apellido1,P.apellido2) Nombres,P.fecha_nacimiento,P.sexo,P.nacionalidad,P.regimen,P.eapb, C.fecha_seg, C.numsegui,FN_CATALOGODESC(87,C.evento),FN_CATALOGODESC(73,C.estado_s),FN_CATALOGODESC(170,C.cierre_caso),C.fecha_cierre,FN_CATALOGODESC(198,C.motivo_cierre),FN_CATALOGODESC(170,C.activa_ruta) activa_ruta,FN_CATALOGODESC(79,C.ruta) Ruta,C.observaciones, C.equipo_bina, C.usu_creo, U.nombre, U.perfil,C.fecha_create,DATEDIFF(C.fecha_create,C.fecha_seg) AS Dias,character_length(C.observaciones) AS largo  FROM `vsp_bpnpret` C LEFT JOIN  person P ON C.idpeople = P.idpeople LEFT JOIN  hog_fam F ON P.vivipersona = F.id_fam LEFT JOIN  hog_geo G ON F.idpre = G.idgeo LEFT JOIN  usuarios U ON C.usu_creo = U.id_usuario UNION 
        SELECT G.subred,G.localidad, F.idpre, F.id_fam,D.id_bpnterm Cod_Registro, D.idpeople,P.idpersona,P.tipo_doc,CONCAT_WS(' ',P.nombre1,P.nombre2,P.apellido1,P.apellido2) Nombres,P.fecha_nacimiento,P.sexo,P.nacionalidad,P.regimen,P.eapb, D.fecha_seg, D.numsegui,FN_CATALOGODESC(87,D.evento),FN_CATALOGODESC(73,D.estado_s),FN_CATALOGODESC(170,D.cierre_caso),D.fecha_cierre,FN_CATALOGODESC(198,D.motivo_cierre),FN_CATALOGODESC(170,D.activa_ruta) activa_ruta,FN_CATALOGODESC(79,D.ruta) Ruta,D.observaciones, D.equipo_bina, D.usu_creo, U.nombre, U.perfil,D.fecha_create,DATEDIFF(D.fecha_create,D.fecha_seg) AS Dias,character_length(D.observaciones) AS largo  FROM `vsp_bpnterm` D LEFT JOIN  person P ON D.idpeople = P.idpeople LEFT JOIN  hog_fam F ON P.vivipersona = F.id_fam LEFT JOIN  hog_geo G ON F.idpre = G.idgeo LEFT JOIN  usuarios U ON D.usu_creo = U.id_usuario UNION 
        SELECT G.subred,G.localidad, F.idpre, F.id_fam,E.id_cancinfa Cod_Registro, E.idpeople,P.idpersona,P.tipo_doc,CONCAT_WS(' ',P.nombre1,P.nombre2,P.apellido1,P.apellido2) Nombres,P.fecha_nacimiento,P.sexo,P.nacionalidad,P.regimen,P.eapb, E.fecha_seg, E.numsegui,FN_CATALOGODESC(87,E.evento),FN_CATALOGODESC(73,E.estado_s),FN_CATALOGODESC(170,E.cierre_caso),E.fecha_cierre,FN_CATALOGODESC(198,E.motivo_cierre),FN_CATALOGODESC(170,E.activa_ruta) activa_ruta,FN_CATALOGODESC(79,E.ruta) Ruta,E.observaciones, E.equipo_bina, E.usu_creo, U.nombre, U.perfil,E.fecha_create,DATEDIFF(E.fecha_create,E.fecha_seg) AS Dias,character_length(E.observaciones) AS largo  FROM `vsp_cancinfa` E LEFT JOIN  person P ON E.idpeople = P.idpeople LEFT JOIN  hog_fam F ON P.vivipersona = F.id_fam LEFT JOIN  hog_geo G ON F.idpre = G.idgeo LEFT JOIN  usuarios U ON E.usu_creo = U.id_usuario UNION 
        SELECT G.subred,G.localidad, F.idpre, F.id_fam,H.id_condsuic Cod_Registro, H.idpeople,P.idpersona,P.tipo_doc,CONCAT_WS(' ',P.nombre1,P.nombre2,P.apellido1,P.apellido2) Nombres,P.fecha_nacimiento,P.sexo,P.nacionalidad,P.regimen,P.eapb, H.fecha_seg, H.numsegui,FN_CATALOGODESC(87,H.evento),FN_CATALOGODESC(73,H.estado_s),FN_CATALOGODESC(170,H.cierre_caso),H.fecha_cierre,FN_CATALOGODESC(198,H.motivo_cierre),FN_CATALOGODESC(170,H.activa_ruta) activa_ruta,FN_CATALOGODESC(79,H.ruta) Ruta,H.observaciones, H.equipo_bina, H.usu_creo, U.nombre, U.perfil,H.fecha_create,DATEDIFF(H.fecha_create,H.fecha_seg) AS Dias,character_length(H.observaciones) AS largo  FROM `vsp_condsuic` H LEFT JOIN  person P ON H.idpeople = P.idpeople LEFT JOIN  hog_fam F ON P.vivipersona = F.id_fam LEFT JOIN  hog_geo G ON F.idpre = G.idgeo LEFT JOIN  usuarios U ON H.usu_creo = U.id_usuario UNION 
        SELECT G.subred,G.localidad, F.idpre, F.id_fam,I.id_cronicos Cod_Registro, I.idpeople,P.idpersona,P.tipo_doc,CONCAT_WS(' ',P.nombre1,P.nombre2,P.apellido1,P.apellido2) Nombres,P.fecha_nacimiento,P.sexo,P.nacionalidad,P.regimen,P.eapb, I.fecha_seg, I.numsegui,FN_CATALOGODESC(87,I.evento),FN_CATALOGODESC(73,I.estado_s),FN_CATALOGODESC(170,I.cierre_caso),I.fecha_cierre,FN_CATALOGODESC(198,I.motivo_cierre),FN_CATALOGODESC(170,I.activa_ruta) activa_ruta,FN_CATALOGODESC(79,I.ruta) Ruta,I.observaciones, I.equipo_bina, I.usu_creo, U.nombre, U.perfil,I.fecha_create,DATEDIFF(I.fecha_create,I.fecha_seg) AS Dias,character_length(I.observaciones) AS largo  FROM `vsp_cronicos` I LEFT JOIN  person P ON I.idpeople = P.idpeople LEFT JOIN  hog_fam F ON P.vivipersona = F.id_fam LEFT JOIN  hog_geo G ON F.idpre = G.idgeo LEFT JOIN  usuarios U ON I.usu_creo = U.id_usuario UNION 
        SELECT G.subred,G.localidad, F.idpre, F.id_fam,J.id_dntsevymod Cod_Registro, J.idpeople,P.idpersona,P.tipo_doc,CONCAT_WS(' ',P.nombre1,P.nombre2,P.apellido1,P.apellido2) Nombres,P.fecha_nacimiento,P.sexo,P.nacionalidad,P.regimen,P.eapb, J.fecha_seg, J.numsegui,FN_CATALOGODESC(87,J.evento),FN_CATALOGODESC(73,J.estado_s),FN_CATALOGODESC(170,J.cierre_caso),J.fecha_cierre,FN_CATALOGODESC(198,J.motivo_cierre),FN_CATALOGODESC(170,J.activa_ruta) activa_ruta,FN_CATALOGODESC(79,J.ruta) Ruta,J.observaciones, J.equipo_bina, J.usu_creo, U.nombre, U.perfil,J.fecha_create,DATEDIFF(J.fecha_create,J.fecha_seg) AS Dias,character_length(J.observaciones) AS largo  FROM `vsp_dntsevymod` J LEFT JOIN  person P ON J.idpeople = P.idpeople LEFT JOIN  hog_fam F ON P.vivipersona = F.id_fam LEFT JOIN  hog_geo G ON F.idpre = G.idgeo LEFT JOIN  usuarios U ON J.usu_creo = U.id_usuario UNION 
        SELECT G.subred,G.localidad, F.idpre, F.id_fam,K.id_eraira Cod_Registro, K.idpeople,P.idpersona,P.tipo_doc,CONCAT_WS(' ',P.nombre1,P.nombre2,P.apellido1,P.apellido2) Nombres,P.fecha_nacimiento,P.sexo,P.nacionalidad,P.regimen,P.eapb, K.fecha_seg, K.numsegui,FN_CATALOGODESC(87,K.evento),FN_CATALOGODESC(73,K.estado_s),FN_CATALOGODESC(170,K.cierre_caso),K.fecha_cierre,FN_CATALOGODESC(198,K.motivo_cierre),FN_CATALOGODESC(170,K.activa_ruta) activa_ruta,FN_CATALOGODESC(79,K.ruta) Ruta,K.observaciones, K.equipo_bina, K.usu_creo, U.nombre, U.perfil,K.fecha_create,DATEDIFF(K.fecha_create,K.fecha_seg) AS Dias,character_length(K.observaciones) AS largo  FROM `vsp_eraira` K LEFT JOIN  person P ON K.idpeople = P.idpeople LEFT JOIN  hog_fam F ON P.vivipersona = F.id_fam LEFT JOIN  hog_geo G ON F.idpre = G.idgeo LEFT JOIN  usuarios U ON K.usu_creo = U.id_usuario UNION 
        SELECT G.subred,G.localidad, F.idpre, F.id_fam,L.id_gestante Cod_Registro, L.idpeople,P.idpersona,P.tipo_doc,CONCAT_WS(' ',P.nombre1,P.nombre2,P.apellido1,P.apellido2) Nombres,P.fecha_nacimiento,P.sexo,P.nacionalidad,P.regimen,P.eapb, L.fecha_seg, L.numsegui,FN_CATALOGODESC(87,L.evento),FN_CATALOGODESC(73,L.estado_s),FN_CATALOGODESC(170,L.cierre_caso),L.fecha_cierre,FN_CATALOGODESC(198,L.motivo_cierre),FN_CATALOGODESC(170,L.activa_ruta) activa_ruta,FN_CATALOGODESC(79,L.ruta) Ruta,L.observaciones, L.equipo_bina, L.usu_creo, U.nombre, U.perfil,L.fecha_create,DATEDIFF(L.fecha_create,L.fecha_seg) AS Dias,character_length(L.observaciones) AS largo  FROM `vsp_gestantes` L LEFT JOIN  person P ON L.idpeople = P.idpeople LEFT JOIN  hog_fam F ON P.vivipersona = F.id_fam LEFT JOIN  hog_geo G ON F.idpre = G.idgeo LEFT JOIN  usuarios U ON L.usu_creo = U.id_usuario UNION 
        SELECT G.subred,G.localidad, F.idpre, F.id_fam,M.id_hbgestacio Cod_Registro, M.idpeople,P.idpersona,P.tipo_doc,CONCAT_WS(' ',P.nombre1,P.nombre2,P.apellido1,P.apellido2) Nombres,P.fecha_nacimiento,P.sexo,P.nacionalidad,P.regimen,P.eapb, M.fecha_seg, M.numsegui,FN_CATALOGODESC(87,M.evento),FN_CATALOGODESC(73,M.estado_s),FN_CATALOGODESC(170,M.cierre_caso),M.fecha_cierre,FN_CATALOGODESC(198,M.motivo_cierre),FN_CATALOGODESC(170,M.activa_ruta) activa_ruta,FN_CATALOGODESC(79,M.ruta) Ruta,M.observaciones, M.equipo_bina, M.usu_creo, U.nombre, U.perfil,M.fecha_create,DATEDIFF(M.fecha_create,M.fecha_seg) AS Dias,character_length(M.observaciones) AS largo  FROM `vsp_hbgest` M LEFT JOIN  person P ON M.idpeople = P.idpeople LEFT JOIN  hog_fam F ON P.vivipersona = F.id_fam LEFT JOIN  hog_geo G ON F.idpre = G.idgeo LEFT JOIN  usuarios U ON M.usu_creo = U.id_usuario UNION 
        SELECT G.subred,G.localidad, F.idpre, F.id_fam,N.id_mnehosp Cod_Registro, N.idpeople,P.idpersona,P.tipo_doc,CONCAT_WS(' ',P.nombre1,P.nombre2,P.apellido1,P.apellido2) Nombres,P.fecha_nacimiento,P.sexo,P.nacionalidad,P.regimen,P.eapb, N.fecha_seg, N.numsegui,FN_CATALOGODESC(87,N.evento),FN_CATALOGODESC(73,N.estado_s),FN_CATALOGODESC(170,N.cierre_caso),N.fecha_cierre,FN_CATALOGODESC(198,N.motivo_cierre),FN_CATALOGODESC(170,N.activa_ruta) activa_ruta,FN_CATALOGODESC(79,N.ruta) Ruta,N.observaciones, N.equipo_bina, N.usu_creo, U.nombre, U.perfil,N.fecha_create,DATEDIFF(N.fecha_create,N.fecha_seg) AS Dias,character_length(N.observaciones) AS largo  FROM `vsp_mnehosp` N LEFT JOIN  person P ON N.idpeople = P.idpeople LEFT JOIN  hog_fam F ON P.vivipersona = F.id_fam LEFT JOIN  hog_geo G ON F.idpre = G.idgeo LEFT JOIN  usuarios U ON N.usu_creo = U.id_usuario UNION 
        SELECT G.subred,G.localidad, F.idpre, F.id_fam,O.id_otroprio Cod_Registro, O.idpeople,P.idpersona,P.tipo_doc,CONCAT_WS(' ',P.nombre1,P.nombre2,P.apellido1,P.apellido2) Nombres,P.fecha_nacimiento,P.sexo,P.nacionalidad,P.regimen,P.eapb, O.fecha_seg, O.numsegui,FN_CATALOGODESC(87,O.evento),FN_CATALOGODESC(73,O.estado_s),FN_CATALOGODESC(170,O.cierre_caso),O.fecha_cierre,FN_CATALOGODESC(198,O.motivo_cierre),FN_CATALOGODESC(170,O.activa_ruta) activa_ruta,FN_CATALOGODESC(79,O.ruta) Ruta,O.observaciones, O.equipo_bina, O.usu_creo, U.nombre, U.perfil,O.fecha_create,DATEDIFF(O.fecha_create,O.fecha_seg) AS Dias,character_length(O.observaciones) AS largo  FROM `vsp_otroprio` O LEFT JOIN  person P ON O.idpeople = P.idpeople LEFT JOIN  hog_fam F ON P.vivipersona = F.id_fam LEFT JOIN  hog_geo G ON F.idpre = G.idgeo LEFT JOIN  usuarios U ON O.usu_creo = U.id_usuario UNION 
        SELECT G.subred,G.localidad, F.idpre, F.id_fam,Q.id_saludoral Cod_Registro, Q.idpeople,P.idpersona,P.tipo_doc,CONCAT_WS(' ',P.nombre1,P.nombre2,P.apellido1,P.apellido2) Nombres,P.fecha_nacimiento,P.sexo,P.nacionalidad,P.regimen,P.eapb, Q.fecha_seg, Q.numsegui,FN_CATALOGODESC(87,Q.evento),FN_CATALOGODESC(73,Q.estado_s),FN_CATALOGODESC(170,Q.cierre_caso),Q.fecha_cierre,FN_CATALOGODESC(198,Q.motivo_cierre),FN_CATALOGODESC(170,Q.activa_ruta) activa_ruta,FN_CATALOGODESC(79,Q.ruta) Ruta,Q.observaciones, Q.equipo_bina, Q.usu_creo, U.nombre, U.perfil,Q.fecha_create,DATEDIFF(Q.fecha_create,Q.fecha_seg) AS Dias,character_length(Q.observaciones) AS largo  FROM `vsp_saludoral` Q LEFT JOIN  person P ON Q.idpeople = P.idpeople LEFT JOIN  hog_fam F ON P.vivipersona = F.id_fam LEFT JOIN  hog_geo G ON F.idpre = G.idgeo LEFT JOIN  usuarios U ON Q.usu_creo = U.id_usuario UNION 
        SELECT G.subred,G.localidad, F.idpre, F.id_fam,R.id_sificong Cod_Registro, R.idpeople,P.idpersona,P.tipo_doc,CONCAT_WS(' ',P.nombre1,P.nombre2,P.apellido1,P.apellido2) Nombres,P.fecha_nacimiento,P.sexo,P.nacionalidad,P.regimen,P.eapb, R.fecha_seg, R.numsegui,FN_CATALOGODESC(87,R.evento),FN_CATALOGODESC(73,R.estado_s),FN_CATALOGODESC(170,R.cierre_caso),R.fecha_cierre,FN_CATALOGODESC(198,R.motivo_cierre),FN_CATALOGODESC(170,R.activa_ruta) activa_ruta,FN_CATALOGODESC(79,R.ruta) Ruta,R.observaciones, R.equipo_bina, R.usu_creo, U.nombre, U.perfil,R.fecha_create,DATEDIFF(R.fecha_create,R.fecha_seg) AS Dias,character_length(R.observaciones) AS largo  FROM `vsp_sificong` R LEFT JOIN  person P ON R.idpeople = P.idpeople LEFT JOIN  hog_fam F ON P.vivipersona = F.id_fam LEFT JOIN  hog_geo G ON F.idpre = G.idgeo LEFT JOIN  usuarios U ON R.usu_creo = U.id_usuario UNION 
        SELECT G.subred,G.localidad, F.idpre, F.id_fam,S.id_sifigest Cod_Registro, S.idpeople,P.idpersona,P.tipo_doc,CONCAT_WS(' ',P.nombre1,P.nombre2,P.apellido1,P.apellido2) Nombres,P.fecha_nacimiento,P.sexo,P.nacionalidad,P.regimen,P.eapb, S.fecha_seg, S.numsegui,FN_CATALOGODESC(87,S.evento),FN_CATALOGODESC(731,S.estado_s),FN_CATALOGODESC(170,S.cierre_caso),S.fecha_cierre,FN_CATALOGODESC(198,S.motivo_cierre),FN_CATALOGODESC(170,S.activa_ruta) activa_ruta,FN_CATALOGODESC(79,S.ruta) Ruta,S.observaciones, S.equipo_bina, S.usu_creo, U.nombre, U.perfil,S.fecha_create,DATEDIFF(S.fecha_create,S.fecha_seg) AS Dias,character_length(S.observaciones) AS largo  FROM `vsp_sifigest` S LEFT JOIN  person P ON S.idpeople = P.idpeople LEFT JOIN  hog_fam F ON P.vivipersona = F.id_fam LEFT JOIN  hog_geo G ON F.idpre = G.idgeo LEFT JOIN  usuarios U ON S.usu_creo = U.id_usuario UNION 
        SELECT G.subred,G.localidad, F.idpre, F.id_fam,T.id_vihgestacio Cod_Registro, T.idpeople,P.idpersona,P.tipo_doc,CONCAT_WS(' ',P.nombre1,P.nombre2,P.apellido1,P.apellido2) Nombres,P.fecha_nacimiento,P.sexo,P.nacionalidad,P.regimen,P.eapb, T.fecha_seg, T.numsegui,FN_CATALOGODESC(87,T.evento),FN_CATALOGODESC(73,T.estado_s),FN_CATALOGODESC(170,T.cierre_caso),T.fecha_cierre,FN_CATALOGODESC(198,T.motivo_cierre),FN_CATALOGODESC(170,T.activa_ruta) activa_ruta,FN_CATALOGODESC(79,T.ruta) Ruta,T.observaciones, T.equipo_bina, T.usu_creo, U.nombre, U.perfil,T.fecha_create,DATEDIFF(T.fecha_create,T.fecha_seg) AS Dias,character_length(T.observaciones) AS largo  FROM `vsp_vihgest` T LEFT JOIN  person P ON T.idpeople = P.idpeople LEFT JOIN  hog_fam F ON P.vivipersona = F.id_fam LEFT JOIN  hog_geo G ON F.idpre = G.idgeo LEFT JOIN  usuarios U ON T.usu_creo = U.id_usuario UNION 
        SELECT G.subred,G.localidad, F.idpre, F.id_fam,V.id_gestante Cod_Registro, V.idpeople,P.idpersona,P.tipo_doc,CONCAT_WS(' ',P.nombre1,P.nombre2,P.apellido1,P.apellido2) Nombres,P.fecha_nacimiento,P.sexo,P.nacionalidad,P.regimen,P.eapb, V.fecha_seg, V.numsegui,FN_CATALOGODESC(87,V.evento),FN_CATALOGODESC(73,V.estado_s),FN_CATALOGODESC(170,V.cierre_caso),V.fecha_cierre,FN_CATALOGODESC(198,V.motivo_cierre),FN_CATALOGODESC(170,V.activa_ruta) activa_ruta,FN_CATALOGODESC(79,V.ruta) Ruta,V.observaciones, V.equipo_bina, V.usu_creo, U.nombre, U.perfil,V.fecha_create,DATEDIFF(V.fecha_create,V.fecha_seg) AS Dias,character_length(V.observaciones) AS largo  FROM `vsp_violges` V LEFT JOIN  person P ON V.idpeople = P.idpeople LEFT JOIN  hog_fam F ON P.vivipersona = F.id_fam LEFT JOIN  hog_geo G ON F.idpre = G.idgeo LEFT JOIN  usuarios U ON V.usu_creo = U.id_usuario UNION 
        SELECT G.subred,G.localidad, F.idpre, F.id_fam,W.id_violreite Cod_Registro,W.idpeople,P.idpersona,P.tipo_doc,CONCAT_WS(' ',P.nombre1,P.nombre2,P.apellido1,P.apellido2) Nombres,P.fecha_nacimiento,P.sexo,P.nacionalidad,P.regimen,P.eapb, W.fecha_seg, W.numsegui,FN_CATALOGODESC(87,W.evento),FN_CATALOGODESC(73,W.estado_s),FN_CATALOGODESC(170,W.cierre_caso),W.fecha_cierre,FN_CATALOGODESC(198,W.motivo_cierre),FN_CATALOGODESC(170,W.activa_ruta) activa_ruta,FN_CATALOGODESC(79,W.ruta) Ruta,W.observaciones, W.equipo_bina, W.usu_creo, U.nombre, U.perfil,W.fecha_create,DATEDIFF(W.fecha_create,W.fecha_seg) AS Dias,character_length(W.observaciones) AS largo  FROM `vsp_violreite` W LEFT JOIN  person P ON W.idpeople = P.idpeople LEFT JOIN  hog_fam F ON P.vivipersona = F.id_fam LEFT JOIN  hog_geo G ON F.idpre = G.idgeo LEFT JOIN usuarios U ON W.usu_creo = U.id_usuario UNION
        SELECT G.subred,G.localidad, F.idpre, F.id_fam,X.Id_mme Cod_Registro,X.idpeople,P.idpersona,P.tipo_doc,CONCAT_WS(' ',P.nombre1,P.nombre2,P.apellido1,P.apellido2) Nombres,P.fecha_nacimiento,P.sexo,P.nacionalidad,P.regimen,P.eapb, X.fecha_seg, X.numsegui,FN_CATALOGODESC(87,X.evento),FN_CATALOGODESC(73,X.estado_s),FN_CATALOGODESC(170,X.cierre_caso),X.fecha_cierre,FN_CATALOGODESC(198,X.motivo_cierre),FN_CATALOGODESC(170,X.activa_ruta) activa_ruta,FN_CATALOGODESC(79,X.ruta) Ruta,X.observaciones,X.equipo, X.usu_creo, U.nombre, U.perfil,X.fecha_create,DATEDIFF(X.fecha_create,X.fecha_seg) AS Dias,character_length(X.observaciones) AS largo  FROM `vsp_mme` X LEFT JOIN  person P ON X.idpeople = P.idpeople LEFT JOIN  hog_fam F ON P.vivipersona = F.id_fam LEFT JOIN  hog_geo G ON F.idpre = G.idgeo LEFT JOIN  usuarios U ON X.usu_creo = U.id_usuario
        ) AS CombinedQuery WHERE fecha_seg >= '$fecha_inicio' AND fecha_seg <='$fecha_fin' AND subred = 3;"

    /* "Pruebas" => "SELECT 1+1", // Este es un ejemplo, no usa fechas
    "Asignacion Predios" => "SELECT * FROM geo_asig WHERE fecha_seg >= '$fecha_inicio' AND fecha_seg <= '$fecha_fin' AND subred = 3",
    "Caracteriz" => "SELECT * FROM hog_carac WHERE fecha_registro >= '$fecha_inicio' AND fecha_registro <= '$fecha_fin'",
    "FECHAS" => "SELECT * FROM fechas WHERE fecha BETWEEN '$fecha_inicio' AND '$fecha_fin'",
    "ALERTAS" => "SELECT * FROM alertas WHERE fecha_alerta >= '$fecha_inicio' AND fecha_alerta <= '$fecha_fin'",
    "VSP" => "SELECT * FROM vsp WHERE fecha_visita >= '$fecha_inicio' AND fecha_visita <= '$fecha_fin'" */
];
// Seleccionar los scripts según el tipo
switch ($tipo) {
    case '1':
        $scripts = [
            "Asignacion Predios" => $todosScripts["Asignacion Predios"],
            "Gestion Predios" => $todosScripts["Gestion Predios"],
            "Compromisos" => $todosScripts["Compromisos"],
            "Seguimientos" => $todosScripts["Seguimientos"],
            "Atenciones" => $todosScripts["Atenciones"],
            "SesColectivas" => $todosScripts["SesColectivas"],
            "SesRBC" => $todosScripts["SesRBC"],
            "SesPsi1" => $todosScripts["SesPsi1"],
            "SesPsi" => $todosScripts["SesPsi"],
            "SesPSi3-10" => $todosScripts["SesPSi3-10"]
        ];
        break;
    case '2':
        $scripts = [
            "Caracteriz_ALL" => $todosScripts["Caracteriz_ALL"],
            "UsuariosXFamilia" => $todosScripts["UsuariosXFamilia"],
            "Promedio" => $todosScripts["Promedio"],
            "VSP" => $todosScripts["VSP"]
        ];
        break;
    case '3':
        $scripts = [
            "FECHAS" => $todosScripts["FECHAS"]
        ];
        break;
    case '4':
        $scripts = [
            "ALERTAS" => $todosScripts["ALERTAS"]
        ];
        break;
    case '5':
        $scripts = [
            "Caracteriz_OK" => $todosScripts["Caracteriz_OK"]
        ];
        break;
    default:
        $scripts = $todosScripts; // Todos los scripts
}
try {
    $spreadsheet = new Spreadsheet();
    $index = 0;
    foreach ($scripts as $nombreHoja => $query) {
        $result = $mysqli->query($query);
        if (!$result) {
            throw new Exception("Error en la consulta ($nombreHoja): " . $mysqli->error);
        }
        $sheet = $spreadsheet->createSheet($index);
        $sheet->setTitle($nombreHoja);
        // Agregar encabezados
        $fields = $result->fetch_fields();
        $col = 1;
        foreach ($fields as $field) {
            $columnLetter = \PhpOffice\PhpSpreadsheet\Cell\Coordinate::stringFromColumnIndex($col);
            $sheet->setCellValue($columnLetter . '1', $field->name);
            $col++;
        }
        // Agregar datos
        $rowNum = 2;
        while ($row = $result->fetch_assoc()) {
            $col = 1;
            foreach ($row as $value) {
                $columnLetter = \PhpOffice\PhpSpreadsheet\Cell\Coordinate::stringFromColumnIndex($col);
                $sheet->setCellValue($columnLetter . $rowNum, $value);
                $col++;
            }
            $rowNum++;
        }
        $index++;
    }
    // $spreadsheet->removeSheetByIndex(0);
    // Generar nombre de archivo
    $nombresArchivos = [
        '1' => 'SIN Validaciones',
        '2' => 'CON Validaciones',
        '3' => 'Fechas',
        '4' => 'Alertas',
        '5' => 'Caracteriz_OK'
    ];
    $filename = ($nombresArchivos[$tipo] ?? 'datos') . '_' . $fecha_inicio . '_a_' . $fecha_fin . '.xlsx';

    $tempDir = sys_get_temp_dir();
    $filePath = $tempDir . DIRECTORY_SEPARATOR . $filename;

    $writer = new Xlsx($spreadsheet);
    $writer->save($filename);

    // Configurar headers para descarga
    header('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
    header('Content-Disposition: attachment; filename="' . $filename . '"');
    header('Content-Length: ' . filesize($filePath));
    header('Cache-Control: must-revalidate');
    header('Pragma: public');
    header('Expires: 0');

    // Enviar el archivo al cliente
    readfile($filePath);

    // Eliminar el archivo temporal
    register_shutdown_function(function() use ($filePath) {
        if (file_exists($filePath)) {
            unlink($filePath);
        }
    });

    // No necesitamos el JSON ahora ya que estamos forzando la descarga directamente
    exit;
    
    /* // Configurar respuesta JSON
    echo json_encode([
        'success' => true,
        'file' => $filename,
        'progreso' => 100,
        'message' => 'Archivo generado correctamente'
    ]);
} catch (Exception $e) {
    echo json_encode([
        'success' => false,
        'message' => $e->getMessage(),
        'progreso' => 0
    ]);
} finally {
    if (isset($mysqli)) {
        $mysqli->close();
    }
}
?> */